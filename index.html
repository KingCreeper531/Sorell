<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sorell</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#080b0f;--bg2:#0e1318;--bg3:#141c24;
  --sur:#1a2330;--sur2:#1f2b3a;--bdr:#243040;
  --acc:#00e5ff;--glow:rgba(0,229,255,.15);
  --txt:#e8eef4;--txt2:#7a8fa0;--txt3:#4a5a6a;
  --red:#ff4d6d;--sw:240px;--ph:90px
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:var(--txt);font-family:'DM Mono',monospace;overflow:hidden;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:var(--bdr);border-radius:2px}
button{cursor:pointer;border:none;background:none;color:inherit}
img{display:block;object-fit:cover}

.app{display:grid;grid-template-columns:var(--sw) 1fr;grid-template-rows:1fr var(--ph);height:100vh}

/* SIDEBAR */
.sb{background:var(--bg2);border-right:1px solid var(--bdr);display:flex;flex-direction:column;overflow:hidden}
.logo{padding:22px 18px 14px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--bdr)}
.logo-box{width:30px;height:30px;background:var(--acc);border-radius:7px;display:grid;place-items:center;flex-shrink:0}
.logo-box svg{width:16px;height:16px;fill:var(--bg)}
.logo-txt{font-family:'Syne',sans-serif;font-weight:800;font-size:16px;letter-spacing:.12em}
.sb-sec{padding:14px 10px 6px}
.sb-lbl{font-size:9px;letter-spacing:.18em;color:var(--txt3);text-transform:uppercase;padding:0 8px;margin-bottom:5px}
.nav{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:9px;cursor:pointer;color:var(--txt2);font-size:12px;transition:all .12s;white-space:nowrap;overflow:hidden}
.nav:hover{background:var(--sur);color:var(--txt)}.nav.on{background:var(--sur);color:var(--acc)}
.nav svg{width:15px;height:15px;fill:currentColor;flex-shrink:0;opacity:.7}.nav.on svg{opacity:1}
.pl-wrap{flex:1;overflow-y:auto;padding:0 10px 12px}
.pl-row{display:flex;align-items:center;gap:9px;padding:7px 10px;border-radius:9px;cursor:pointer;color:var(--txt2);font-size:11px;transition:all .12s}
.pl-row:hover{background:var(--sur);color:var(--txt)}
.pl-ic{width:26px;height:26px;border-radius:6px;background:var(--sur2);display:grid;place-items:center;flex-shrink:0;font-size:11px}
.pl-nm{flex:1;min-width:0}
.pl-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:11px}
.pl-ct{font-size:9px;color:var(--txt3)}
.new-pl{margin:0 10px 10px;padding:8px;border:1px dashed var(--bdr);border-radius:9px;color:var(--txt3);font-size:11px;font-family:'DM Mono',monospace;transition:all .12s;display:flex;align-items:center;justify-content:center;gap:5px;cursor:pointer}
.new-pl:hover{border-color:var(--acc);color:var(--acc);background:var(--glow)}
.new-pl svg{width:11px;height:11px;fill:currentColor}

/* MAIN */
.main{display:flex;flex-direction:column;overflow:hidden}
.topbar{padding:14px 26px;display:flex;align-items:center;gap:14px;border-bottom:1px solid var(--bdr);background:var(--bg);flex-shrink:0}
.srch{flex:1;max-width:420px;position:relative}
.srch input{width:100%;padding:9px 34px;background:var(--sur);border:1px solid var(--bdr);border-radius:50px;color:var(--txt);font-family:'DM Mono',monospace;font-size:12px;outline:none;transition:border .12s,box-shadow .12s}
.srch input::placeholder{color:var(--txt3)}.srch input:focus{border-color:var(--acc);box-shadow:0 0 0 3px var(--glow)}
.srch-ico{position:absolute;left:11px;top:50%;transform:translateY(-50%);width:14px;height:14px;stroke:var(--txt3);fill:none;pointer-events:none}
.srch-x{position:absolute;right:11px;top:50%;transform:translateY(-50%);width:15px;height:15px;cursor:pointer;fill:var(--txt3);display:none}
.status{display:flex;align-items:center;gap:6px;font-size:10px;color:var(--txt2)}
.dot{width:6px;height:6px;border-radius:50%;background:var(--acc)}
.content{flex:1;overflow-y:auto;padding:22px 26px}

/* VIEWS */
.view{display:none}.view.on{display:block}

/* HERO */
.hero{background:linear-gradient(135deg,#0a1520,#0e2030 40%,#051018);border:1px solid var(--bdr);border-radius:14px;padding:28px;margin-bottom:24px;position:relative;overflow:hidden}
.hero::before{content:'';position:absolute;top:-40px;right:-40px;width:180px;height:180px;background:radial-gradient(circle,rgba(0,229,255,.1),transparent 70%);pointer-events:none}
.hero h1{font-family:'Syne',sans-serif;font-size:30px;font-weight:800;line-height:1.1;margin-bottom:6px}
.hero h1 span{color:var(--acc)}.hero p{color:var(--txt2);font-size:11px}

/* CARDS */
.sh{display:flex;align-items:center;margin-bottom:12px}
.sh h2{font-family:'Syne',sans-serif;font-size:13px;font-weight:700}
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(148px,1fr));gap:12px;margin-bottom:28px}
.card{background:var(--bg3);border:1px solid var(--bdr);border-radius:9px;overflow:hidden;cursor:pointer;transition:transform .14s,box-shadow .14s}
.card:hover{transform:translateY(-3px);box-shadow:0 8px 24px rgba(0,0,0,.4)}
.card-img{width:100%;aspect-ratio:1;background:var(--sur);position:relative;overflow:hidden}
.card-img img{width:100%;height:100%;transition:transform .3s}.card:hover .card-img img{transform:scale(1.06)}
.card-ov{position:absolute;inset:0;background:rgba(0,0,0,.5);display:grid;place-items:center;opacity:0;transition:opacity .14s}.card:hover .card-ov{opacity:1}
.card-pb{width:38px;height:38px;background:var(--acc);border-radius:50%;display:grid;place-items:center;transform:scale(.8);transition:transform .14s}.card:hover .card-pb{transform:scale(1)}
.card-pb svg{width:14px;height:14px;fill:var(--bg)}
.card-info{padding:9px 11px}
.card-nm{font-family:'Syne',sans-serif;font-size:11px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
.card-sub{font-size:10px;color:var(--txt3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ph{width:100%;height:100%;display:grid;place-items:center;background:var(--sur2)}.ph svg{width:35%;height:35%;fill:var(--bdr)}

/* TRACKLIST */
.tlh{display:grid;grid-template-columns:30px 1fr 150px 64px 40px;padding:5px 10px;font-size:9px;color:var(--txt3);letter-spacing:.08em;text-transform:uppercase;border-bottom:1px solid var(--bdr);margin-bottom:3px}
.tlr{display:grid;grid-template-columns:30px 1fr 150px 64px 40px;align-items:center;padding:6px 10px;border-radius:7px;cursor:pointer;transition:background .1s}
.tlr:hover{background:var(--sur)}.tlr.on{background:var(--sur)}.tlr.on .tlt{color:var(--acc)}
.tln{font-size:11px;color:var(--txt3);text-align:center}
.tlr.playing .tln-n{display:none}.tlr.playing .eq{display:flex!important}
.eq{display:none;align-items:center;justify-content:center;gap:2px;height:13px}
.eq span{width:2px;background:var(--acc);border-radius:1px;animation:eq .6s ease-in-out infinite alternate}
.eq span:nth-child(1){height:5px}.eq span:nth-child(2){height:11px;animation-delay:.15s}
.eq span:nth-child(3){height:7px;animation-delay:.3s}.eq span:nth-child(4){height:9px;animation-delay:.1s}
@keyframes eq{from{transform:scaleY(.35)}to{transform:scaleY(1)}}
.tlm{display:flex;align-items:center;gap:10px;min-width:0;padding-left:8px;overflow:hidden}
.tlth{width:34px;height:34px;border-radius:5px;overflow:hidden;flex-shrink:0;background:var(--sur)}
.tlth img{width:100%;height:100%}
.tltw{min-width:0;overflow:hidden}
.tlt{font-size:11px;font-family:'Syne',sans-serif;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
.tla{font-size:10px;color:var(--txt3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer}.tla:hover{color:var(--acc)}
.tlc{font-size:10px;color:var(--txt2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding-right:6px;min-width:0}
.tld{font-size:10px;color:var(--txt3);text-align:right;padding-right:8px;font-variant-numeric:tabular-nums}
.tlk{display:flex;align-items:center;justify-content:flex-end}
.lbtn{width:22px;height:22px;display:grid;place-items:center;border-radius:50%;color:var(--txt3);opacity:0;transition:all .12s}
.tlr:hover .lbtn,.lbtn.on{opacity:1}.lbtn.on{color:var(--red)}.lbtn svg{width:11px;height:11px;fill:currentColor}

/* TABS */
.tabs{display:flex;gap:3px;margin-bottom:18px;border-bottom:1px solid var(--bdr)}
.tab{padding:7px 12px;font-size:11px;cursor:pointer;color:var(--txt3);border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .12s}
.tab:hover{color:var(--txt)}.tab.on{color:var(--acc);border-bottom-color:var(--acc)}

/* COLLECTION */
.coll{display:flex;gap:22px;align-items:flex-end;margin-bottom:26px}
.coll-art{width:155px;height:155px;border-radius:11px;overflow:hidden;flex-shrink:0;background:var(--sur);display:grid;place-items:center;font-size:46px;box-shadow:0 8px 28px rgba(0,0,0,.4)}
.coll-art img{width:100%;height:100%}
.heart-art{background:linear-gradient(135deg,#0a1520,#003344)}.heart-art svg{width:55px;height:55px;fill:var(--acc)}
.coll-type{font-size:9px;letter-spacing:.14em;color:var(--txt3);text-transform:uppercase;margin-bottom:5px}
.coll-nm{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;letter-spacing:-.02em;margin-bottom:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
.coll-meta{font-size:11px;color:var(--txt2);margin-bottom:18px}
.coll-acts{display:flex;gap:9px}
.btn-play{padding:9px 20px;border-radius:50px;font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;transition:all .12s;border:none;display:flex;align-items:center;gap:6px;background:var(--acc);color:var(--bg);font-weight:600}
.btn-play:hover{background:#33eeff}.btn-play svg{width:13px;height:13px;fill:currentColor}
.btn-out{padding:9px 18px;border-radius:50px;font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;transition:all .12s;border:1px solid var(--bdr);color:var(--txt2);background:transparent;display:flex;align-items:center;gap:6px}
.btn-out:hover{border-color:var(--txt2);color:var(--txt)}.btn-out svg{width:13px;height:13px;fill:currentColor}

/* YOUTUBE PLAYER */
.yt-wrap{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:500;display:none;align-items:center;justify-content:center;backdrop-filter:blur(8px)}
.yt-wrap.on{display:flex}
.yt-box{background:var(--bg2);border:1px solid var(--bdr);border-radius:16px;overflow:hidden;width:min(860px,95vw)}
.yt-top{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--bdr)}
.yt-info{min-width:0}.yt-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:calc(100% - 10px)}
.yt-artist{font-size:11px;color:var(--txt2);margin-top:2px}
.yt-close{width:32px;height:32px;display:grid;place-items:center;border-radius:50%;transition:background .12s;flex-shrink:0}
.yt-close:hover{background:var(--sur)}.yt-close svg{width:18px;height:18px;fill:var(--txt2)}
.yt-frame{width:100%;aspect-ratio:16/9}
.yt-frame iframe{width:100%;height:100%;border:none;display:block}

/* PLAYER BAR */
.player{grid-row:2/3;grid-column:1/3;background:var(--bg2);border-top:1px solid var(--bdr);display:grid;grid-template-columns:1fr 2fr 1fr;align-items:center;padding:0 22px;gap:14px;position:relative}
.player::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--acc),transparent);opacity:0;transition:opacity .5s}
.player.playing::before{opacity:.5}
.np{display:flex;align-items:center;gap:11px}
.np-art{width:50px;height:50px;border-radius:7px;overflow:hidden;background:var(--sur);flex-shrink:0}
.np-art img{width:100%;height:100%}
.np-ph{width:100%;height:100%;display:grid;place-items:center}.np-ph svg{width:18px;height:18px;fill:var(--txt3)}
.np-info{min-width:0;flex:1}
.np-title{font-family:'Syne',sans-serif;font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px;max-width:160px}
.np-artist{font-size:10px;color:var(--txt3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.np-like{width:26px;height:26px;flex-shrink:0;cursor:pointer;display:grid;place-items:center;transition:transform .12s}
.np-like:hover{transform:scale(1.2)}.np-like svg{width:15px;height:15px;stroke:var(--txt3);fill:none}
.np-like.on svg{stroke:var(--red);fill:var(--red)}
.np-yt{width:26px;height:26px;flex-shrink:0;cursor:pointer;display:grid;place-items:center;border-radius:50%;transition:background .12s}
.np-yt:hover{background:var(--sur)}.np-yt svg{width:15px;height:15px;fill:var(--txt3)}
.np-yt:hover svg{fill:var(--red)}
.ctrls{display:flex;flex-direction:column;align-items:center;gap:7px}
.ctrl-row{display:flex;align-items:center;gap:7px}
.cbtn{width:28px;height:28px;display:grid;place-items:center;border-radius:50%;color:var(--txt2);transition:color .12s,background .12s}
.cbtn:hover{color:var(--txt);background:var(--sur)}.cbtn.on{color:var(--acc)}.cbtn svg{width:15px;height:15px;fill:currentColor}
.pbtn{width:38px;height:38px;background:var(--acc);border-radius:50%;display:grid;place-items:center;transition:transform .1s,background .12s}
.pbtn:hover{transform:scale(1.06);background:#33eeff}.pbtn svg{width:15px;height:15px;fill:var(--bg)}
.prog-row{display:flex;align-items:center;gap:9px;width:100%;max-width:460px}
.ptime{font-size:10px;color:var(--txt3);min-width:30px;font-variant-numeric:tabular-nums}.ptime.r{text-align:right}
.pbar{flex:1;height:4px;background:var(--sur2);border-radius:2px;cursor:pointer;position:relative}
.pfill{height:100%;background:var(--acc);border-radius:2px;width:0%;pointer-events:none;transition:width .25s linear}
.vol-row{display:flex;align-items:center;justify-content:flex-end;gap:9px}
.vico{color:var(--txt3);cursor:pointer;display:flex;align-items:center}.vico svg{width:15px;height:15px;fill:currentColor}
.vbar{width:76px;height:4px;background:var(--sur2);border-radius:2px;cursor:pointer}.vfill{height:100%;background:var(--txt2);border-radius:2px;width:70%}

/* MODALS */
.mbg{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.mbg.on{display:flex}
.modal{background:var(--bg2);border:1px solid var(--bdr);border-radius:14px;padding:26px;width:360px;max-width:92vw;animation:mpop .22s ease}
@keyframes mpop{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
.modal h2{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;margin-bottom:18px}
.minp{width:100%;padding:9px 12px;background:var(--sur);border:1px solid var(--bdr);border-radius:7px;color:var(--txt);font-family:'DM Mono',monospace;font-size:12px;outline:none;margin-bottom:14px}
.minp:focus{border-color:var(--acc)}
.macts{display:flex;gap:9px;justify-content:flex-end}
.mcan{padding:8px 16px;border-radius:7px;font-family:'DM Mono',monospace;font-size:11px;color:var(--txt2);border:1px solid var(--bdr);cursor:pointer;background:none}
.mok{padding:8px 16px;border-radius:7px;background:var(--acc);font-family:'DM Mono',monospace;font-size:11px;font-weight:600;color:var(--bg);cursor:pointer;border:none}

/* CTX MENU */
.ctx{position:fixed;background:var(--bg2);border:1px solid var(--bdr);border-radius:9px;padding:5px;z-index:400;min-width:175px;box-shadow:0 8px 28px rgba(0,0,0,.5);display:none}
.ci{padding:7px 11px;font-size:11px;cursor:pointer;border-radius:6px;color:var(--txt2);display:flex;align-items:center;gap:7px;transition:all .1s}
.ci:hover{background:var(--sur);color:var(--txt)}.ci svg{width:11px;height:11px;fill:currentColor;flex-shrink:0}
.cdiv{height:1px;background:var(--bdr);margin:3px 0}

/* TOAST */
.toasts{position:fixed;bottom:104px;right:18px;display:flex;flex-direction:column;gap:7px;z-index:1000;pointer-events:none}
.toast{background:var(--sur2);border:1px solid var(--bdr);border-radius:7px;padding:9px 13px;font-size:11px;animation:tin .25s ease;max-width:280px}
@keyframes tin{from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:translateX(0)}}

/* MISC */
.spin{display:flex;align-items:center;justify-content:center;padding:50px;color:var(--txt3);font-size:11px;gap:7px}
.spinner{width:15px;height:15px;border:2px solid var(--bdr);border-top-color:var(--acc);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:50px 18px;color:var(--txt3)}
.empty svg{width:44px;height:44px;fill:var(--bdr);margin:0 auto 12px}
.empty h3{font-family:'Syne',sans-serif;font-size:15px;color:var(--txt2);margin-bottom:5px}.empty p{font-size:11px}
.big-title{font-family:'Syne',sans-serif;font-size:21px;font-weight:800;margin-bottom:20px}
</style>
</head>
<body>
<div class="app">

  <!-- SIDEBAR -->
  <aside class="sb">
    <div class="logo">
      <div class="logo-box"><svg viewBox="0 0 24 24"><path d="M3 18v-6a9 9 0 0 1 18 0v6"/><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3v5z"/><path d="M3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3v5z"/></svg></div>
      <div class="logo-txt">SORELL</div>
    </div>
    <div class="sb-sec">
      <div class="sb-lbl">Navigation</div>
      <div class="nav on" data-v="home" onclick="showView('home')"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>Home</div>
      <div class="nav" data-v="search" onclick="focusSrch()"><svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>Search</div>
      <div class="nav" data-v="liked" onclick="showView('liked')"><svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>Liked Songs</div>
      <div class="nav" data-v="queue" onclick="showView('queue')"><svg viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z"/></svg>Queue</div>
    </div>
    <div class="sb-sec"><div class="sb-lbl">Playlists</div></div>
    <div class="pl-wrap" id="sidebarPl"></div>
    <div class="new-pl" onclick="openCreatePl()"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>New Playlist</div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <div class="srch">
        <svg class="srch-ico" viewBox="0 0 24 24" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input id="srchInp" type="text" placeholder="Search songs, artists..." autocomplete="off">
        <svg class="srch-x" id="srchX" viewBox="0 0 24 24" onclick="clearSrch()"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
      </div>
      <div class="status"><div class="dot"></div><span>YouTube + Last.fm</span></div>
    </div>

    <div class="content" id="contentEl">

      <!-- HOME -->
      <div class="view on" id="view-home">
        <div class="hero">
          <h1>Free music,<br><span>full songs.</span></h1>
          <p>Powered by YouTube &amp; Last.fm &nbsp;Â·&nbsp; No login &nbsp;Â·&nbsp; Click any track to play</p>
        </div>
        <div class="sh"><h2>Trending Now</h2></div>
        <div id="homeTrend"><div class="spin"><div class="spinner"></div>Loading...</div></div>
        <div class="sh" style="margin-top:4px"><h2>New Releases</h2></div>
        <div class="cards" id="homeNew"><div class="spin" style="grid-column:1/-1"><div class="spinner"></div></div></div>
      </div>

      <!-- SEARCH -->
      <div class="view" id="view-search">
        <div id="srchEmpty" class="empty">
          <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
          <h3>Search for music</h3><p>Find any song, artist, or album</p>
        </div>
        <div id="srchRes" style="display:none">
          <div class="tabs">
            <div class="tab on" onclick="switchTab(this,'tracks')">Tracks</div>
            <div class="tab" onclick="switchTab(this,'artists')">Artists</div>
          </div>
          <div id="srchContent"></div>
        </div>
      </div>

      <!-- LIKED -->
      <div class="view" id="view-liked">
        <div class="coll">
          <div class="coll-art heart-art"><svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg></div>
          <div>
            <div class="coll-type">Collection</div>
            <div class="coll-nm">Liked Songs</div>
            <div class="coll-meta" id="likedMeta">0 songs</div>
            <div class="coll-acts">
              <button class="btn-play" onclick="playLikedAll()"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>Play All</button>
              <button class="btn-out" onclick="shuffleLiked()"><svg viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>Shuffle</button>
            </div>
          </div>
        </div>
        <div id="likedList"></div>
      </div>

      <!-- QUEUE -->
      <div class="view" id="view-queue">
        <div class="big-title">Queue</div>
        <div id="qNow"></div>
        <div style="font-size:10px;text-transform:uppercase;letter-spacing:.1em;color:var(--txt3);margin:14px 0 9px 3px">Next up</div>
        <div id="qList"></div>
      </div>

      <!-- PLAYLIST VIEW -->
      <div class="view" id="view-pl">
        <div class="coll" id="plHd"></div>
        <div id="plTracks"></div>
      </div>

      <!-- ARTIST VIEW -->
      <div class="view" id="view-artist">
        <div class="coll" id="artistHd"></div>
        <div class="sh"><h2>Top Tracks</h2></div>
        <div id="artistTracks"></div>
      </div>

    </div>
  </main>

  <!-- PLAYER -->
  <footer class="player" id="playerEl">
    <div class="np">
      <div class="np-art" id="npArt"><div class="np-ph"><svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg></div></div>
      <div class="np-info">
        <div class="np-title" id="npTitle">Nothing playing</div>
        <div class="np-artist" id="npArtist">â€”</div>
      </div>
      <div class="np-like" id="npLike" onclick="toggleLikeCur()">
        <svg viewBox="0 0 24 24" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
      </div>
      <div class="np-yt" onclick="openYT()" title="Watch on YouTube">
        <svg viewBox="0 0 24 24"><path d="M21.543 6.498C22 8.28 22 12 22 12s0 3.72-.457 5.502c-.254.985-.997 1.76-1.938 2.022C17.896 20 12 20 12 20s-5.893 0-7.605-.476c-.945-.266-1.687-1.04-1.938-2.022C2 15.72 2 12 2 12s0-3.72.457-5.502c.254-.985.997-1.76 1.938-2.022C6.107 4 12 4 12 4s5.896 0 7.605.476c.945.266 1.687 1.04 1.938 2.022zM10 15.5l6-3.5-6-3.5v7z"/></svg>
      </div>
    </div>
    <div class="ctrls">
      <div class="ctrl-row">
        <button class="cbtn" id="shufBtn" onclick="toggleShuffle()"><svg viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg></button>
        <button class="cbtn" onclick="skipPrev()"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"/></svg></button>
        <button class="pbtn" onclick="togglePlay()">
          <svg id="playIco" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          <svg id="pauseIco" viewBox="0 0 24 24" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        </button>
        <button class="cbtn" onclick="skipNext()"><svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
        <button class="cbtn" id="repBtn" onclick="toggleRepeat()"><svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg></button>
      </div>
      <div class="prog-row">
        <span class="ptime" id="pCur">0:00</span>
        <div class="pbar" id="pBar" onclick="seekTo(event)"><div class="pfill" id="pFill"></div></div>
        <span class="ptime r" id="pDur">0:00</span>
      </div>
    </div>
    <div class="vol-row">
      <div class="vico" onclick="toggleMute()">
        <svg id="volOn" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
        <svg id="volOff" viewBox="0 0 24 24" style="display:none"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3 3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4 9.91 6.09 12 8.18V4z"/></svg>
      </div>
      <div class="vbar" id="vBar" onclick="setVol(event)"><div class="vfill" id="vFill"></div></div>
    </div>
  </footer>
</div>

<!-- YOUTUBE PLAYER OVERLAY -->
<div class="yt-wrap" id="ytWrap">
  <div class="yt-box">
    <div class="yt-top">
      <div class="yt-info">
        <div class="yt-title" id="ytTitle">â€”</div>
        <div class="yt-artist" id="ytArtist">â€”</div>
      </div>
      <button class="yt-close" onclick="closeYT()"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
    </div>
    <div class="yt-frame"><iframe id="ytFrame" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe></div>
  </div>
</div>

<!-- CREATE PLAYLIST MODAL -->
<div class="mbg" id="createPlMod" onclick="if(event.target===this)closeMods()">
  <div class="modal"><h2>New Playlist</h2>
    <input class="minp" id="plInp" type="text" placeholder="Playlist name..." onkeydown="if(event.key==='Enter')confirmPl()">
    <div class="macts"><button class="mcan" onclick="closeMods()">Cancel</button><button class="mok" onclick="confirmPl()">Create</button></div>
  </div>
</div>

<!-- ADD TO PLAYLIST MODAL -->
<div class="mbg" id="addPlMod" onclick="if(event.target===this)closeMods()">
  <div class="modal"><h2>Add to Playlist</h2>
    <div id="addPlList" style="max-height:210px;overflow-y:auto;margin-bottom:14px"></div>
    <div class="macts"><button class="mcan" onclick="closeMods()">Cancel</button></div>
  </div>
</div>

<!-- CONTEXT MENU -->
<div class="ctx" id="ctx">
  <div class="ci" onclick="ctxPlay()"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>Play</div>
  <div class="ci" onclick="ctxYT()"><svg viewBox="0 0 24 24"><path d="M21.543 6.498C22 8.28 22 12 22 12s0 3.72-.457 5.502c-.254.985-.997 1.76-1.938 2.022C17.896 20 12 20 12 20s-5.893 0-7.605-.476c-.945-.266-1.687-1.04-1.938-2.022C2 15.72 2 12 2 12s0-3.72.457-5.502c.254-.985.997-1.76 1.938-2.022C6.107 4 12 4 12 4s5.896 0 7.605.476c.945.266 1.687 1.04 1.938 2.022zM10 15.5l6-3.5-6-3.5v7z"/></svg>Open in YouTube</div>
  <div class="ci" onclick="ctxNext()"><svg viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>Play next</div>
  <div class="ci" onclick="ctxQueue()"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>Add to queue</div>
  <div class="cdiv"></div>
  <div class="ci" id="ctxLike" onclick="ctxDoLike()"><svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>Like</div>
  <div class="ci" onclick="ctxAddPl()"><svg viewBox="0 0 24 24"><path d="M14 10H3v2h11v-2zm0-4H3v2h11V6zm4 8v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zM3 16h7v-2H3v2z"/></svg>Add to playlist</div>
  <div class="ci" onclick="ctxArtist()"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>Go to artist</div>
</div>

<div class="toasts" id="toasts"></div>

<!-- YOUTUBE IFrame API -->
<script src="https://www.youtube.com/iframe_api"></script>

<script>
// ============================================================
//  CONFIG
// ============================================================
const LASTFM_KEY = '6b3d34288b36612d975df34ad090760f'; // FREE at last.fm/api â€” takes 30 seconds

// ============================================================
//  LAST.FM API  (open CORS, works from any domain, no auth)
// ============================================================
async function lfm(method, params = {}) {
  const u = new URL('https://ws.audioscrobbler.com/2.0/');
  u.searchParams.set('method', method);
  u.searchParams.set('api_key', LASTFM_KEY);
  u.searchParams.set('format', 'json');
  u.searchParams.set('limit', params.limit || 20);
  Object.entries(params).forEach(([k,v]) => u.searchParams.set(k, v));
  try {
    const r = await fetch(u.toString());
    if (r.ok) return r.json();
  } catch {}
  return null;
}

function lfmImg(imgs) {
  if (!imgs) return '';
  const big = imgs.find(i => i.size === 'extralarge') || imgs.find(i => i.size === 'large') || imgs[imgs.length-1];
  return big?.['#text'] || '';
}

function toT(t) {
  if (!t) return null;
  const art = lfmImg(t.image);
  return {
    id: t.url || (t.name + t.artist?.name),
    name: t.name || 'Unknown',
    artist: typeof t.artist === 'string' ? t.artist : (t.artist?.name || 'Unknown'),
    art: art,
    duration: parseInt(t.duration || 0) * 1000,
    url: t.url || ''
  };
}

// ============================================================
//  YOUTUBE PLAYER
// ============================================================
let ytPlayer = null, ytReady = false, ytPendingId = null;
let progressTimer = null;

function onYouTubeIframeAPIReady() {
  ytPlayer = new YT.Player('ytFrame', {
    height: '100%', width: '100%',
    playerVars: { autoplay: 0, controls: 1, rel: 0, modestbranding: 1 },
    events: {
      onReady: () => { ytReady = true; if (ytPendingId) { loadYT(ytPendingId); ytPendingId = null; } },
      onStateChange: onYTState
    }
  });
}

function onYTState(e) {
  if (e.data === YT.PlayerState.PLAYING) {
    isPlaying = true; setPlayUI(true);
    clearInterval(progressTimer);
    progressTimer = setInterval(updateProgress, 500);
  } else if (e.data === YT.PlayerState.PAUSED) {
    isPlaying = false; setPlayUI(false);
    clearInterval(progressTimer);
  } else if (e.data === YT.PlayerState.ENDED) {
    clearInterval(progressTimer);
    if (repeatMode === 2) { ytPlayer.seekTo(0); ytPlayer.playVideo(); return; }
    if (repeatMode === 1 || qi < queue.length - 1) skipNext();
    else { isPlaying = false; setPlayUI(false); }
  }
}

function updateProgress() {
  if (!ytPlayer || !ytReady) return;
  try {
    const cur = ytPlayer.getCurrentTime() || 0;
    const dur = ytPlayer.getDuration() || 0;
    if (dur > 0) {
      document.getElementById('pFill').style.width = (cur/dur*100) + '%';
      document.getElementById('pCur').textContent = fmt(cur*1000);
      document.getElementById('pDur').textContent = fmt(dur*1000);
    }
  } catch {}
}

// Search YouTube for a track and return the video ID
const ytCache = {};

// Multiple Piped instances (community-run YouTube frontends, no API key needed)
const PIPED_INSTANCES = [
  'https://pipedapi.kavin.rocks',
  'https://pipedapi.adminforge.de',
  'https://pipedapi.moomoo.me',
  'https://pipedapi.drgns.space',
];

async function findYTId(track, artist) {
  const key = `${track}|${artist}`;
  if (ytCache[key]) return ytCache[key];

  const queries = [
    `${track} ${artist} official audio`,
    `${track} ${artist}`,
    `${track} ${artist} lyrics`,
  ];

  for (const q of queries) {
    const encoded = encodeURIComponent(q);
    for (const base of PIPED_INSTANCES) {
      try {
        const r = await fetch(`${base}/search?q=${encoded}&filter=music_songs`, {
          signal: AbortSignal.timeout(4000)
        });
        if (r.ok) {
          const d = await r.json();
          const item = d?.items?.find(i => i.type === 'stream' || i.url?.startsWith('/watch'));
          if (item?.url) {
            const id = item.url.replace('/watch?v=', '').split('&')[0];
            if (id && id.length === 11) { ytCache[key] = id; return id; }
          }
        }
      } catch {}
    }

    // Also try Invidious instances
    const invidiousInstances = [
      'https://invidious.nerdvpn.de',
      'https://invidious.privacydev.net',
    ];
    for (const base of invidiousInstances) {
      try {
        const r = await fetch(`${base}/api/v1/search?q=${encoded}&type=video&fields=videoId`, {
          signal: AbortSignal.timeout(4000)
        });
        if (r.ok) {
          const d = await r.json();
          const id = d?.[0]?.videoId;
          if (id && id.length === 11) { ytCache[key] = id; return id; }
        }
      } catch {}
    }
  }
  return null;
}

function loadYT(videoId) {
  if (!ytReady) { ytPendingId = videoId; return; }
  ytPlayer.loadVideoById(videoId);
}

function openYT() {
  if (!cur) return;
  document.getElementById('ytWrap').classList.add('on');
  document.getElementById('ytTitle').textContent = cur.name;
  document.getElementById('ytArtist').textContent = cur.artist;
  if (cur.ytId) loadYT(cur.ytId);
}

function closeYT() {
  document.getElementById('ytWrap').classList.remove('on');
}

// ============================================================
//  STATE
// ============================================================
let cur = null, queue = [], qi = -1, isShuffle = false, repeatMode = 0,
    isMuted = false, vol = 0.7, isPlaying = false, curTab = 'tracks', cache = {}, ctxT = null;
let liked    = JSON.parse(localStorage.getItem('sorell_liked') || '[]');
let likedIds = new Set(liked.map(t => t.id));
let pls      = JSON.parse(localStorage.getItem('sorell_pls') || '[]');

// ============================================================
//  HOME
// ============================================================
async function loadHome() {
  // Top tracks chart
  const r1 = await lfm('chart.getTopTracks', { limit: 15 });
  const tracks = (r1?.tracks?.track || []).map(toT).filter(Boolean);
  document.getElementById('homeTrend').innerHTML = tracks.length
    ? renderTL(tracks, tracks)
    : '<div class="empty"><p>Could not load. Check your Last.fm API key.</p></div>';

  // Top artists -> show as cards
  const r2 = await lfm('chart.getTopArtists', { limit: 12 });
  const artists = r2?.artists?.artist || [];
  document.getElementById('homeNew').innerHTML = artists.length
    ? artists.map(a => mkArtistCard(a)).join('')
    : '';
}

function mkArtistCard(a) {
  const img = lfmImg(a.image);
  return `<div class="card" onclick="loadArtist('${esc(a.name)}')">
    <div class="card-img" style="border-radius:50%">${img ? `<img src="${img}" loading="lazy" alt="">` : `<div class="ph"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div>`}
      <div class="card-ov"><div class="card-pb"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div></div>
    </div>
    <div class="card-info"><div class="card-nm">${esc(a.name)}</div><div class="card-sub">${parseInt(a.listeners||0).toLocaleString()} listeners</div></div>
  </div>`;
}

// ============================================================
//  SEARCH
// ============================================================
let sTimer = null;
document.getElementById('srchInp').addEventListener('input', function() {
  const q = this.value.trim();
  document.getElementById('srchX').style.display = q ? 'block' : 'none';
  clearTimeout(sTimer);
  if (!q) { showView('search'); resetSrch(); return; }
  showView('search');
  document.getElementById('srchEmpty').style.display = 'none';
  document.getElementById('srchRes').style.display = 'block';
  document.getElementById('srchContent').innerHTML = '<div class="spin"><div class="spinner"></div>Searching...</div>';
  sTimer = setTimeout(() => doSearch(q), 380);
});

async function doSearch(q) {
  const k = q.toLowerCase();
  if (!cache[k]) {
    const [tr, ar] = await Promise.all([
      lfm('track.search', { track: q, limit: 30 }),
      lfm('artist.search', { artist: q, limit: 20 })
    ]);
    cache[k] = {
      tracks: (tr?.results?.trackmatches?.track || []).map(t => toT({ ...t, image: t.image })).filter(Boolean),
      artists: ar?.results?.artistmatches?.artist || []
    };
  }
  renderTab(curTab, cache[k]);
}

function switchTab(el, tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
  el.classList.add('on'); curTab = tab;
  const k = document.getElementById('srchInp').value.trim().toLowerCase();
  if (cache[k]) renderTab(tab, cache[k]);
}

function renderTab(tab, data) {
  const c = document.getElementById('srchContent');
  if (tab === 'tracks')
    c.innerHTML = data.tracks?.length ? renderTL(data.tracks, data.tracks) : '<div class="empty"><p>No tracks found</p></div>';
  else
    c.innerHTML = data.artists?.length ? `<div class="cards">${data.artists.map(mkArtistCard).join('')}</div>` : '<div class="empty"><p>No artists found</p></div>';
}

function resetSrch() { document.getElementById('srchEmpty').style.display='block'; document.getElementById('srchRes').style.display='none'; }
function clearSrch()  { document.getElementById('srchInp').value=''; document.getElementById('srchX').style.display='none'; resetSrch(); }

// ============================================================
//  TRACKLIST
// ============================================================
function renderTL(tracks, q) {
  if (!tracks?.length) return '<div class="empty"><p>No tracks</p></div>';
  let h = `<div class="tlh"><div>#</div><div>Title</div><div>Artist</div><div>Duration</div><div></div></div>`;
  tracks.forEach((t, i) => {
    if (!t) return;
    const lk = likedIds.has(t.id), act = cur?.id === t.id;
    h += `<div class="tlr ${act?'on':''} ${act&&isPlaying?'playing':''}" data-id="${esc(t.id)}"
      onclick="playTrack(${ja(t)},${ja(tracks)})" oncontextmenu="showCtx(event,${ja(t)});return false;">
      <div class="tln"><div class="eq"><span></span><span></span><span></span><span></span></div><span class="tln-n">${i+1}</span></div>
      <div class="tlm">
        <div class="tlth">${t.art ? `<img src="${t.art}" loading="lazy" alt="">` : ''}</div>
        <div class="tltw">
          <div class="tlt">${esc(t.name)}</div>
          <div class="tla" onclick="event.stopPropagation();loadArtist('${esc(t.artist)}')">${esc(t.artist)}</div>
        </div>
      </div>
      <div class="tlc">${esc(t.artist)}</div>
      <div class="tld">${fmt(t.duration)}</div>
      <div class="tlk"><button class="lbtn ${lk?'on':''}" onclick="event.stopPropagation();toggleLike(${ja(t)})">
        <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
      </button></div>
    </div>`;
  });
  return h;
}

// ============================================================
//  PLAYBACK  â€” finds YouTube video ID and plays it
// ============================================================
async function playTrack(t, nq = null) {
  if (!t) return;
  cur = t;
  if (nq) { queue = nq; qi = nq.findIndex(x => x.id === t.id); }
  // Update player bar UI immediately
  document.getElementById('npTitle').textContent = t.name;
  document.getElementById('npArtist').textContent = t.artist;
  document.getElementById('npArt').innerHTML = t.art
    ? `<img src="${t.art}" alt="">`
    : `<div class="np-ph"><svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg></div>`;
  document.getElementById('npLike').classList.toggle('on', likedIds.has(t.id));
  document.getElementById('pFill').style.width = '0%';
  document.getElementById('pCur').textContent = '0:00';
  document.getElementById('pDur').textContent = fmt(t.duration);
  document.getElementById('ytTitle').textContent = t.name;
  document.getElementById('ytArtist').textContent = t.artist;
  updateHL(t.id);
  document.title = `${t.name} â€” ${t.artist} Â· Sorell`;

  // Find YouTube video ID
  toast(`Loading "${t.name}"...`);
  const ytId = await findYTId(t.name, t.artist);
  if (!ytId) {
    // Last resort: open YouTube search in the embed directly
    const searchQuery = encodeURIComponent(`${t.name} ${t.artist}`);
    toast(`Opening YouTube search for "${t.name}"...`);
    document.getElementById('ytWrap').classList.add('on');
    document.getElementById('ytFrame').src = `https://www.youtube.com/embed?listType=search&list=${searchQuery}&autoplay=1`;
    return;
  }
  cur.ytId = ytId;

  // Open YouTube player and play
  document.getElementById('ytWrap').classList.add('on');
  loadYT(ytId);
  wVol(isMuted ? 0 : vol);
}

function setPlayUI(p) {
  isPlaying = p;
  document.getElementById('playIco').style.display  = p ? 'none'  : 'block';
  document.getElementById('pauseIco').style.display = p ? 'block' : 'none';
  document.getElementById('playerEl').classList.toggle('playing', p);
  updateHL(cur?.id);
}

function updateHL(id) {
  document.querySelectorAll('.tlr').forEach(r => {
    r.classList.toggle('on',      r.dataset.id === id);
    r.classList.toggle('playing', r.dataset.id === id && isPlaying);
  });
}

function togglePlay() {
  if (!ytReady || !cur) return;
  isPlaying ? ytPlayer.pauseVideo() : ytPlayer.playVideo();
}

function skipNext() {
  if (!queue.length) return;
  qi = isShuffle ? Math.floor(Math.random()*queue.length) : (qi+1) % queue.length;
  playTrack(queue[qi]);
}

function skipPrev() {
  if (ytReady && ytPlayer.getCurrentTime() > 3) { ytPlayer.seekTo(0); return; }
  if (!queue.length) return;
  qi = Math.max(0, qi-1); playTrack(queue[qi]);
}

function seekTo(e) {
  if (!ytReady) return;
  const pct = e.offsetX / document.getElementById('pBar').offsetWidth;
  const dur = ytPlayer.getDuration() || 0;
  ytPlayer.seekTo(pct * dur);
  document.getElementById('pFill').style.width = (pct*100) + '%';
}

function wVol(v) { if (ytReady) ytPlayer.setVolume(Math.round(v*100)); }

function setVol(e) {
  vol = Math.max(0, Math.min(1, e.offsetX / document.getElementById('vBar').offsetWidth));
  document.getElementById('vFill').style.width = (vol*100)+'%';
  wVol(vol); isMuted = false;
  document.getElementById('volOn').style.display = 'block';
  document.getElementById('volOff').style.display = 'none';
  document.getElementById('vFill').style.opacity = '1';
}

function toggleMute() {
  isMuted = !isMuted; wVol(isMuted ? 0 : vol);
  document.getElementById('volOn').style.display  = isMuted ? 'none'  : 'block';
  document.getElementById('volOff').style.display = isMuted ? 'block' : 'none';
  document.getElementById('vFill').style.opacity  = isMuted ? '.3' : '1';
}

function toggleShuffle() { isShuffle=!isShuffle; document.getElementById('shufBtn').classList.toggle('on',isShuffle); toast(isShuffle?'Shuffle on':'Shuffle off'); }
function toggleRepeat()  { repeatMode=(repeatMode+1)%3; document.getElementById('repBtn').classList.toggle('on',repeatMode>0); toast(['Repeat off','Repeat all','Repeat one'][repeatMode]); }

// ============================================================
//  ARTIST VIEW
// ============================================================
async function loadArtist(name) {
  showView('artist');
  document.getElementById('artistHd').innerHTML = '<div class="spin"><div class="spinner"></div></div>';
  const [info, tracks] = await Promise.all([
    lfm('artist.getInfo', { artist: name }),
    lfm('artist.getTopTracks', { artist: name, limit: 30 })
  ]);
  const img = lfmImg(info?.artist?.image);
  document.getElementById('artistHd').innerHTML = `
    <div class="coll-art">${img ? `<img src="${img}" alt="">` : 'ðŸŽµ'}</div>
    <div>
      <div class="coll-type">Artist</div>
      <div class="coll-nm">${esc(info?.artist?.name || name)}</div>
      <div class="coll-meta">${parseInt(info?.artist?.stats?.listeners||0).toLocaleString()} listeners</div>
      <div class="coll-acts">
        <button class="btn-play" onclick="playArtist('${esc(name)}')"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>Play</button>
      </div>
    </div>`;
  const ts = (tracks?.toptracks?.track || []).map(t => toT({...t, artist: {name}})).filter(Boolean);
  document.getElementById('artistTracks').innerHTML = ts.length ? renderTL(ts, ts) : '<div class="empty"><p>No tracks</p></div>';
}

async function playArtist(name) {
  const r = await lfm('artist.getTopTracks', { artist: name, limit: 20 });
  const ts = (r?.toptracks?.track || []).map(t => toT({...t, artist: {name}})).filter(Boolean);
  if (ts.length) playTrack(ts[0], ts);
}

// ============================================================
//  LIKED SONGS
// ============================================================
function toggleLike(t) {
  if (likedIds.has(t.id)) { liked = liked.filter(x => x.id !== t.id); likedIds.delete(t.id); toast('Removed from Liked Songs'); }
  else { liked.unshift(t); likedIds.add(t.id); toast('Added to Liked Songs \u2665'); }
  localStorage.setItem('sorell_liked', JSON.stringify(liked));
  document.querySelectorAll('.tlr').forEach(r => { if (r.dataset.id === t.id) r.querySelector('.lbtn')?.classList.toggle('on', likedIds.has(t.id)); });
  if (cur?.id === t.id) document.getElementById('npLike').classList.toggle('on', likedIds.has(t.id));
  document.getElementById('likedMeta').textContent = `${liked.length} songs`;
}
function toggleLikeCur() { if (cur) toggleLike(cur); }
function renderLiked() {
  document.getElementById('likedMeta').textContent = `${liked.length} songs`;
  document.getElementById('likedList').innerHTML = liked.length
    ? renderTL(liked, liked)
    : '<div class="empty"><svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg><h3>No liked songs yet</h3><p>Heart tracks to save them here</p></div>';
}
function playLikedAll()  { if (liked.length) playTrack(liked[0], liked); }
function shuffleLiked()  { if (!liked.length) return; isShuffle=true; document.getElementById('shufBtn').classList.add('on'); playTrack(liked[Math.floor(Math.random()*liked.length)], liked); }

// ============================================================
//  LOCAL PLAYLISTS
// ============================================================
function renderSbPl() {
  document.getElementById('sidebarPl').innerHTML = pls.length
    ? pls.map(p => `<div class="pl-row" onclick="openLocalPl('${p.id}')"><div class="pl-ic">ðŸŽµ</div><div class="pl-nm"><div class="pl-name">${esc(p.name)}</div><div class="pl-ct">${p.tracks.length} tracks</div></div></div>`).join('')
    : '<div style="padding:7px 18px;font-size:11px;color:var(--txt3)">No playlists yet</div>';
}
function openCreatePl() { document.getElementById('plInp').value=''; document.getElementById('createPlMod').classList.add('on'); setTimeout(()=>document.getElementById('plInp').focus(),100); }
function confirmPl() { const n=document.getElementById('plInp').value.trim(); if(!n)return; pls.push({id:'pl_'+Date.now(),name:n,tracks:[]}); savePls(); renderSbPl(); closeMods(); toast(`"${n}" created`); }
function savePls() { localStorage.setItem('sorell_pls', JSON.stringify(pls)); }
function openLocalPl(id) {
  const p = pls.find(x => x.id === id); if (!p) return;
  showView('pl');
  document.getElementById('plHd').innerHTML = `
    <div class="coll-art heart-art">ðŸŽµ</div>
    <div><div class="coll-type">Playlist</div><div class="coll-nm">${esc(p.name)}</div>
      <div class="coll-meta">${p.tracks.length} songs</div>
      <div class="coll-acts">
        <button class="btn-play" onclick="pls.find(x=>x.id==='${id}')?.tracks[0]&&playTrack(pls.find(x=>x.id==='${id}').tracks[0],pls.find(x=>x.id==='${id}').tracks)"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>Play All</button>
        <button class="btn-out" onclick="deletePl('${id}')"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>Delete</button>
      </div>
    </div>`;
  document.getElementById('plTracks').innerHTML = p.tracks.length ? renderTL(p.tracks, p.tracks) : '<div class="empty"><p>Right-click any track to add it here.</p></div>';
}
function deletePl(id) { pls=pls.filter(p=>p.id!==id); savePls(); renderSbPl(); showView('home'); toast('Playlist deleted'); }
function addToPl(t, plId) { const p=pls.find(x=>x.id===plId); if(!p)return; if(p.tracks.some(x=>x.id===t.id)){toast('Already in playlist');closeMods();return;} p.tracks.push(t); savePls(); renderSbPl(); toast(`Added to "${p.name}"`); closeMods(); }
function closeMods() { document.querySelectorAll('.mbg').forEach(m=>m.classList.remove('on')); }

// ============================================================
//  QUEUE
// ============================================================
function renderQueue() {
  if (!cur) return;
  document.getElementById('qNow').innerHTML = `<div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--sur);border-radius:9px;margin-bottom:7px;border-left:3px solid var(--acc)">
    <div style="width:48px;height:48px;border-radius:7px;overflow:hidden;background:var(--sur2);flex-shrink:0">${cur.art?`<img src="${cur.art}" style="width:100%;height:100%" alt="">`:''}</div>
    <div><div style="font-size:9px;color:var(--acc);text-transform:uppercase;letter-spacing:.1em;margin-bottom:3px">Now Playing</div>
      <div style="font-family:'Syne',sans-serif;font-size:13px;font-weight:700;margin-bottom:2px">${esc(cur.name)}</div>
      <div style="font-size:10px;color:var(--txt2)">${esc(cur.artist)}</div>
    </div>
  </div>`;
  const up = queue.slice(qi+1, qi+11);
  document.getElementById('qList').innerHTML = up.length ? renderTL(up, up) : '<div class="empty"><p>Queue is empty</p></div>';
}

// ============================================================
//  CONTEXT MENU
// ============================================================
function showCtx(e, t) {
  e.preventDefault(); ctxT = t;
  const m = document.getElementById('ctx'); m.style.display = 'block';
  document.getElementById('ctxLike').innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>${likedIds.has(t.id)?'Unlike':'Like'}`;
  let x = e.clientX, y = e.clientY;
  if (x+190 > window.innerWidth) x = window.innerWidth - 195;
  if (y+250 > window.innerHeight) y = y - 210;
  m.style.left = x+'px'; m.style.top = y+'px';
}
document.addEventListener('click', e => { if (!document.getElementById('ctx').contains(e.target)) document.getElementById('ctx').style.display='none'; });
function ctxPlay()   { if(ctxT) playTrack(ctxT, queue.length?queue:[ctxT]); document.getElementById('ctx').style.display='none'; }
function ctxYT()     { if(ctxT) { cur=ctxT; openYT(); } document.getElementById('ctx').style.display='none'; }
function ctxNext()   { if(ctxT){queue.splice(qi+1,0,ctxT);toast('Playing next');} document.getElementById('ctx').style.display='none'; }
function ctxQueue()  { if(ctxT){queue.push(ctxT);toast('Added to queue');} document.getElementById('ctx').style.display='none'; }
function ctxDoLike() { if(ctxT) toggleLike(ctxT); document.getElementById('ctx').style.display='none'; }
function ctxArtist() { if(ctxT) loadArtist(ctxT.artist); document.getElementById('ctx').style.display='none'; }
function ctxAddPl() {
  document.getElementById('ctx').style.display='none';
  if (!pls.length) { toast('Create a playlist first'); return; }
  document.getElementById('addPlList').innerHTML = pls.map(p =>
    `<div class="ci" onclick="addToPl(ctxT,'${p.id}')"><svg viewBox="0 0 24 24"><path d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8.18c-.31-.11-.65-.18-1-.18-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3V8h3V6h-5z"/></svg>${esc(p.name)}<span style="margin-left:auto;font-size:10px;color:var(--txt3)">${p.tracks.length}</span></div>`
  ).join('');
  document.getElementById('addPlMod').classList.add('on');
}

// ============================================================
//  NAV
// ============================================================
function showView(v) {
  document.querySelectorAll('.view').forEach(x => x.classList.remove('on'));
  document.getElementById('view-'+v)?.classList.add('on');
  document.querySelectorAll('.nav').forEach(n => n.classList.toggle('on', n.dataset.v === v));
  if (v==='liked') renderLiked();
  if (v==='queue') renderQueue();
  document.getElementById('contentEl').scrollTop = 0;
}
function focusSrch() { showView('search'); document.getElementById('srchInp').focus(); }

// ============================================================
//  UTILS
// ============================================================
function toast(msg) { const el=document.createElement('div'); el.className='toast'; el.textContent=msg; document.getElementById('toasts').appendChild(el); setTimeout(()=>el.remove(),3200); }
function fmt(ms) { if (!ms) return '0:00'; const s=Math.floor(ms/1000); return `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`; }
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function ja(o)  { return JSON.stringify(o).replace(/"/g,'&quot;'); }

document.addEventListener('keydown', e => {
  if (['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
  if (e.code==='Space') { e.preventDefault(); togglePlay(); }
  if (e.code==='ArrowRight'&&e.altKey) skipNext();
  if (e.code==='ArrowLeft'&&e.altKey)  skipPrev();
  if (e.code==='Escape') { closeYT(); closeMods(); }
});

// ============================================================
//  INIT
// ============================================================
// Check if Last.fm key is set
if (LASTFM_KEY === 'PLACEHOLDER_NEVER_MATCHES') {
  document.getElementById('homeTrend').innerHTML = `<div class="empty">
    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
    <h3>One quick step</h3>
    <p>Get a free Last.fm API key at <strong>last.fm/api</strong> and paste it in index.html where it says YOUR_LASTFM_KEY</p>
  </div>`;
  document.getElementById('homeNew').innerHTML = '';
} else {
  loadHome();
}

renderSbPl();
</script>
</body>
</html>